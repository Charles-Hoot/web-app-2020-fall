#!/usr/bin/env node

// Load environment variables from .env file,
// where API keys and passwords can be configured.
// dotenv.config({ path: '.env.example' })
const dotenv = require('dotenv');
const vars = dotenv.config({ path: '.env' });
if (vars.error) {
  throw vars.error;
}
console.info(process.env.PORT);
console.info(vars.parsed);
console.info('Environment variables loaded.');

const debug = require('debug')('web-app-2020-fall:server');
const http = require('http');
const db = require('../models/index');

/**
 * Get port from environment and store in Express.
 */

const port = normalizePort(process.env.PORT || '3020');

const app = require('../app');
app.set('port', port);
console.log(`Server Launch at port: ${port}`);

/**
 * Create HTTP server.
 */
const server = http.createServer(app);

/**
 * Listen on provided port, on all network interfaces.
 */
server.listen(port);
server.on('error', onError);
server.on('listening', onListening);

/**
 * Normalize a port into a number, string, or false.
 */

function normalizePort(val) {
  const port = parseInt(val, 10);
  if (isNaN(port)) {
    // named pipe
    return val;
  }
  if (port >= 0) {
    // port number
    return port;
  }
  return false;
}

/**
 * Event listener for HTTP server "error" event.
 */
function onError(error) {
  if (error.syscall !== 'listen') {
    throw error;
  }

  const bind = typeof port === 'string' ? 'Pipe ' + port : 'Port ' + port;

  // handle specific listen errors with friendly messages
  switch (error.code) {
    case 'EACCES':
      console.error(bind + ' requires elevated privileges');
      process.exit(1);
      break;
    case 'EADDRINUSE':
      console.error(bind + ' is already in use');
      process.exit(1);
      break;
    default:
      throw error;
  }
}

// Database functions
async function assertDatabaseConnectionOk() {
  console.log(`Checking database connection...`);
  try {
    await db.authenticate();
    console.log('Database connection OK!');
  } catch (error) {
    console.log('Unable to connect to the database:');
    console.log(error.message);
    process.exit(1);
  }
}

async function dbInit() {
  await assertDatabaseConnectionOk();
}

async function seedDatabase() {
  console.log('Initialize database with dummy data.');
  await db.sync({ force: true });
  //console.dir(db.models);

  // Dr. Case - rabbit
  try {
  await db.models.Rabbit.bulkCreate([
    { name: 'Bugs', age: 2, isCartoon: true },
    { name: 'Huggy', age: 2, isCartoon: false },
    { name: 'Doc', age: 2, isCartoon: true },
  ]);
  const numRabbits = await db.models.Rabbit.count();
  console.info(`Seeded ${numRabbits} rabbits.`);
}
catch (err) {
  console.error(`ERROR: Rabbit - ${err.message}`)
}

  // Dr. Hoot - tea

  // Blake - game
  try {
  await db.models.Game.bulkCreate([
    {name: "Uno",  playerCount: 6, isCardGame: true},

    {name: "Sorry",  playerCount: 4, isCardGame: false},

    {name: "Monopoly",  playerCount: 4, isCardGame: false},
  ]);
  const numGames = await db.models.Game.count();
  console.info(`Seeded ${numGames} games.`);
} catch (err) {
  console.error(`ERROR: Game - ${err.message}`)
}

  // Varsha - animal
  await db.models.Animal.bulkCreate([
    { name: 'Dog', lifeSpan: 22, isPet: true },
    { name: 'Fox', lifeSpan: 14, isPet: false },
    { name: 'Cat', lifeSpan: 25, isPet: true },
  ]);
  const numAnimals = await db.models.Animal.count();
  console.info(`Seeded ${numAnimals} animals.`);

  // Felipe - ?

  // Jack - chief

  // Sreenidhi - plant
  try {
  await db.models.Plant.bulkCreate([
    { name: 'Hibiscus', variety: 1, isPlant: true },
    { name: 'Apple', variety: 1, isPlant: false },
    { name: 'AloeVera', variety: 2, isPlant: true },
  ]);
  const numPlant = await db.models.Plant.count();
  console.info(`Seeded ${numPlant} plant.`);
}
catch (err) {
  console.error(`ERROR: - Plant ${err.message}`)
}


  // Nithya - series
  await db.models.Series.bulkCreate([
    { name: 'Better Things', seasons: 4, isComedy: true },
    { name: 'Breaking Bad', seasons: 5, isComedy: false },
    { name: 'Money Heist', seasons: 4, isComedy: false }
  ]);
  const numSeries = await db.models.Series.count();
  console.info(`Seeded ${numSeries} seriess.`);


  // Sri Vasavi - food
  await db.models.Food.bulkCreate([
    { name: 'Lamb', pricePerLB: 8, isMeat: true },
    { name: 'Fish', pricePerLB: 4, isMeat: true },
    { name: 'Spinach', pricePerLB: 2, isMeat: false },
  ]);
  const numFood = await db.models.Food.count();
  console.info(`Seeded ${numFood} foods.`);

  // Joseph - software

  // Stephen - whiskey
  try {
  await db.models.Whiskey.bulkCreate([
    { name: 'Laphroaig 10', age: 10, is: true },
    { name: 'Highland Park 12', age: 12, is: true },
    { name: 'Redbreast 12', age: 12, is: false },
  ]);
  const numWhiskey = await db.models.Whiskey.count();
  console.info(`Seeded ${numWhiskey} whiskey.`);
}
catch (err) {
  console.error(`ERROR: - Whiskey ${err.message}`)
}

  // Shivani - book
  try {
  await db.models.book.bulkCreate([
  { book: "harrypotter ", publishedDate: 1997, isFantasy: true},
  { book: "animalfarm ", publishedDate :1945, isFantasy :  false},
  { book: "hobbit" , publishedDate : 1937, isFantasy : true  },
]);
const numbook= await db.models.book.count();
  console.info(`Seeded ${numbook} book.`);
}
catch (err) {
  console.error(`ERROR: - Book ${err.message}`)
}

  // Kunal - videoGame

  // Chandler - company


  // Praneeth - cricket
  await db.models.Cricket.bulkCreate([
    { teamName: 'Indian Team', age: 2, captain: 'Dhoni' },
    { teamName: 'Australian Team', age: 2, captain: 'Smith' },
    { teamName: 'South African Team', age: 2, captain: 'ABD' },
  ]);
  const numCricket = await db.models.Cricket.count();
  console.info(`Seeded ${numCricket} cricket team.`);


  // Zach - fruit

  // Prashansa - dance
  try {
  await db.models.dance.bulkCreate([
  { form : "Kuchipudi",    yearIntro: 1502 ,  isTraditional : True},
{  form : "Bollywood ",   yearIntro :  1960, isTraditional : False},
{ form: "Bhagra",  yearIntro :1940, isTraditional : True},
]);
const numdance= await db.models.dance.count();
  console.info(`Seeded ${numdance} dance.`);
}
catch (err) {
  console.error(`ERROR: - Dance ${err.message}`)
}

  // Sam - ship

// Lindsey - pokemon



  console.log('Done seeding!');
}

/**
 * Event listener for HTTP server "listening" event.
 */
function onListening() {
  dbInit();
  seedDatabase();
  const addr = server.address();
  const bind = typeof addr === 'string' ? 'pipe ' + addr : 'port ' + addr.port;
  debug('Listening on ' + bind);
}
